require("dotenv").config();

const OpenAI = require("openai");
const { toFile } = require("openai");

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ==========================================
// ðŸ”¥ ìž¬ë£Œ ì •ì œ í•¨ìˆ˜ (GPTìš© ìž¬ë£Œëª…ë§Œ ì¶”ì¶œ)
// ==========================================
function extractPureIngredient(str) {
  return str
    .replace(/[0-9]/g, "")                     // ìˆ«ìž ì œê±°
    .replace(/\([^)]*\)/g, "")                 // ê´„í˜¸ ì œê±°
    .replace(/g|ì»µ|í°ìˆ |ìž‘ì€ìˆ |ìª½|ê°œ|ëª¨|ì•½ê°„|ml|L|ëŒ€|ë§ˆë¦¬/g, "") // ë‹¨ìœ„ ì œê±°
    .replace(/ +/g, " ")
    .trim();
}


// ===============================
// GPT JSON ë ˆì‹œí”¼ ìƒì„±
// ===============================
exports.askGPT = async (message) => {
  const res = await client.chat.completions.create({
    model: "gpt-4o-mini",
    response_format: { type: "json_object" },

    messages: [
      {
        role: "system",
        content: `
ë‹¹ì‹ ì€ 'Cooking Assistant' ìš”ë¦¬ ì „ë¬¸ AIìž…ë‹ˆë‹¤.
assistantMessageëŠ” ì ˆëŒ€ë¡œ ì¶œë ¥í•˜ì§€ ë§ê³  **ë ˆì‹œí”¼ JSONë§Œ** ìƒì„±í•˜ì„¸ìš”.

ë°˜ë“œì‹œ ì•„ëž˜ JSON êµ¬ì¡° **ê·¸ëŒ€ë¡œ** ì‚¬ìš©í•©ë‹ˆë‹¤:

{
  "recipeName": "",
  "fullIngredients": [],
  "ingredients": [],
  "steps": []
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[fullIngredients ê·œì¹™ - bullet í˜•ì‹ ê°•ì œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fullIngredientsëŠ” ë‹¤ìŒê³¼ ê°™ì€ **ë¬¸ìžì—´ ë°°ì—´**ì´ì–´ì•¼ í•©ë‹ˆë‹¤.

- ê° í•­ëª©ì€ ë°˜ë“œì‹œ "â€¢ " ë¡œ ì‹œìž‘í•´ì•¼ í•©ë‹ˆë‹¤.
- "â€¢ ìž¬ë£Œëª… + ì •í™•í•œ ì–‘" í˜•ì‹ìœ¼ë¡œ ìž‘ì„±í•˜ì„¸ìš”.
- í•œ í•­ëª©ì— ì—¬ëŸ¬ ìž¬ë£Œë¥¼ ì½¤ë§ˆ(,)ë¡œ ë¬¶ì§€ ë§ê³ , ìž¬ë£Œë§ˆë‹¤ í•œ ì¤„ì”© ë„£ìœ¼ì„¸ìš”.

ì˜ˆì‹œ:

"fullIngredients": [
  "â€¢ ë¬µì€ ê¹€ì¹˜ 300g",
  "â€¢ ë‘ë¶€ 200g",
  "â€¢ ë¼ì§€ê³ ê¸° ì•žë‹¤ë¦¬ì‚´ 150g",
  "â€¢ ì–‘íŒŒ 1ê°œ(ì•½ 150g)",
  "â€¢ ëŒ€íŒŒ 1ëŒ€",
  "â€¢ ë§ˆëŠ˜ 3ìª½",
  "â€¢ ê³ ì¶§ê°€ë£¨ 2í°ìˆ ",
  "â€¢ êµ­ê°„ìž¥ 1í°ìˆ ",
  "â€¢ ì†Œê¸ˆ ì•½ê°„",
  "â€¢ ë¬¼ 4ì»µ"
]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ingredients ê·œì¹™]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ingredients ë°°ì—´ì—ëŠ” "ìˆœìˆ˜ ìž¬ë£Œëª…"ë§Œ ë„£ìŠµë‹ˆë‹¤.
ì˜ˆ:
"ingredients": [
  "ë¬µì€ ê¹€ì¹˜",
  "ë‘ë¶€",
  "ë¼ì§€ê³ ê¸° ì•žë‹¤ë¦¬ì‚´",
  "ì–‘íŒŒ",
  "ëŒ€íŒŒ",
  "ë§ˆëŠ˜",
  "ê³ ì¶§ê°€ë£¨",
  "êµ­ê°„ìž¥",
  "ì†Œê¸ˆ",
  "ë¬¼"
]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[steps ê·œì¹™ - ë§¤ìš° ìžì„¸í•˜ê²Œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
stepsëŠ” ë‹¤ìŒ ê·œì¹™ì„ ë°˜ë“œì‹œ ë”°ë¦…ë‹ˆë‹¤.

1) ê° ë‹¨ê³„ëŠ” í•œê¸€ ë¬¸ìž¥ í•˜ë‚˜ ì´ìƒì˜ ë¬¸ìžì—´ë¡œ ìž‘ì„±.
2) ìµœì†Œ 6ë‹¨ê³„ ì´ìƒ.
3) ì´ˆë°˜ ë‹¨ê³„ì— **ìž¬ë£Œ ì†ì§ˆ ë°©ë²•**ì„ ë°˜ë“œì‹œ ë„£ìœ¼ì„¸ìš”:
   - ì˜ˆ: "ë¬µì€ ê¹€ì¹˜ 300gì€ í•œ ìž… í¬ê¸°ë¡œ ìžë¦…ë‹ˆë‹¤."
   - ì˜ˆ: "ëŒ€íŒŒ 1ëŒ€ëŠ” ì†¡ì†¡ ì°ì–´ì¤ë‹ˆë‹¤."
   - ì˜ˆ: "ë‘ë¶€ 200gì€ í•œ ìž… í¬ê¸° ì •ì‚¬ê°í˜•ìœ¼ë¡œ ì°ì–´ì¤ë‹ˆë‹¤."
4) ìž¬ë£Œë¥¼ ë„£ì„ ë•Œ, **ê°€ëŠ¥í•œ í•œ ì–‘ì„ ë‹¤ì‹œ í•œ ë²ˆ ì–¸ê¸‰**í•©ë‹ˆë‹¤.
   - ì˜ˆ: "ëƒ„ë¹„ì— ë¬¼ 4ì»µì„ ë¶“ê³  ì¤‘ë¶ˆì—ì„œ ë“ìž…ë‹ˆë‹¤."
   - ì˜ˆ: "ë¬µì€ ê¹€ì¹˜ 300gê³¼ ë¼ì§€ê³ ê¸° 150gì„ ë„£ê³  5ë¶„ê°„ ë³¶ì•„ì£¼ì„¸ìš”."
5) ë„êµ¬/ë¶ˆ ì„¸ê¸°/ì‹œê°„ì„ ë°˜ë“œì‹œ í¬í•¨í•©ë‹ˆë‹¤.
   - ë„êµ¬: ëƒ„ë¹„, íŒ¬, ì¹¼, ë„ë§ˆ, êµ­ìž ë“±
   - ë¶ˆ ì„¸ê¸°: ì•½ë¶ˆ / ì¤‘ì•½ë¶ˆ / ì¤‘ë¶ˆ / ì„¼ë¶ˆ
   - ì‹œê°„: "ì•½ 3ë¶„ê°„", "5~7ë¶„ ì •ë„"ì²˜ëŸ¼ êµ¬ì²´ì ìœ¼ë¡œ
6) ë§ˆì§€ë§‰ ë‹¨ê³„ì—ëŠ” ì™„ì„± ìƒíƒœ(ìƒ‰ê¹”, ë†ë„, ë§› í¬ì¸íŠ¸)ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ê¸°íƒ€]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ë°˜ë“œì‹œ JSON í˜•ì‹ë§Œ ì¶œë ¥í•˜ê³ , JSON ë°”ê¹¥ì— ì„¤ëª… ë¬¸ìž¥ì„ ì“°ì§€ ë§ˆì„¸ìš”.
- "json"ì´ë¼ëŠ” ë‹¨ì–´ëŠ” ì´ system ë©”ì‹œì§€ ì•ˆì— í¬í•¨ë˜ì–´ ìžˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
        `
      },
      { role: "user", content: message }
    ]
  });

  return res.choices[0].message.content;
};



// ===============================
// GPT Follow-up â€” ì˜ˆì˜ê³  ì•ˆì •ì ì¸ assistantMessage ìƒì„±
// ===============================
exports.askGPTFollowup = async (recipe, question) => {

  const recipeForGPT = {
    ...recipe,
    ingredients: recipe.fullIngredients
      ? recipe.fullIngredients.map(extractPureIngredient)
      : recipe.ingredients,
  };

  const res = await client.chat.completions.create({
    model: "gpt-4o",
    response_format: { type: "json_object" },

    messages: [
      {
        role: "system",
        content: `
ë‹¹ì‹ ì€ 'Cooking Assistant'ìž…ë‹ˆë‹¤.

âš ï¸ ì ˆëŒ€ ê·œì¹™:
- assistantMessageëŠ” ë°˜ë“œì‹œ ì˜ˆìœ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì•¼ í•¨
- ì¤„ë°”ê¿ˆ(\\n)ì„ ì‚¬ìš©í•´ ë¬¸ë‹¨/ë¬¸ìž¥ì„ ë‚˜ëˆ„ê³  ì½ê¸° íŽ¸í•˜ê²Œ ìž‘ì„±
- ê¸´ ë¬¸ìž¥ì€ 1~2ì¤„ ë‹¨ìœ„ë¡œ ëŠì–´ì„œ ì¶œë ¥
- ëª©ë¡ì€ "- í•­ëª©" ë˜ëŠ” "â€¢ í•­ëª©" í˜•íƒœë¡œ ì •ë¦¬
- ì„ íƒì§€ëŠ” "1) ..." í˜•íƒœë¡œ ê° ì¤„ ë¶„ë¦¬
- "ì‹œìž‘í•´", "ìš”ë¦¬ ì‹œìž‘"ê³¼ ê°™ì€ ëª…ë ¹ì´ ì˜¤ê¸° ì „ì—ëŠ” ì ˆëŒ€ stepsë¥¼ ì¶œë ¥í•˜ì§€ ë§ ê²ƒ
- "ì‹œìž‘í•´ë³¼ê¹Œìš”", "ë°”ë¡œ ì‹œìž‘í•´ìš”" ê°™ì€ ë¬¸ìž¥ë„ ê¸ˆì§€

assistantMessage ë§ˆì§€ë§‰ì—ëŠ” ë°˜ë“œì‹œ ì•„ëž˜ 2ì¤„ì„ í¬í•¨í•˜ì„¸ìš”:

"ë ˆì‹œí”¼ë¥¼ ì—…ë°ì´íŠ¸í–ˆì–´ìš”!
ì¶”ê°€ë¡œ ì¡°ì •í•  ë¶€ë¶„ì´ ìžˆë‹¤ë©´ ë§ì”€í•´ì£¼ì„¸ìš”."

âš ï¸ assistantMessage ì•ˆì—ëŠ” 'ì‹œìž‘í•´', 'ìš”ë¦¬ ì‹œìž‘', 'ì‹œìž‘í• ê¹Œìš”' ê°™ì€ í‘œí˜„ì„ ë„£ì§€ ë§ˆì„¸ìš”.
ì‹œìž‘ ì—¬ë¶€ëŠ” ì‚¬ìš©ìžê°€ ì§ì ‘ ë§í•©ë‹ˆë‹¤.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ì²˜ë¦¬í•´ì•¼ í•  ìƒí™©]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1) ìž¬ë£Œ ì—†ìŒ:
   - "ì–‘íŒŒ ì—†ì–´", "ëŒ€íŒŒ ì—†ëŠ”ë°" ë“±
   â†’ ê°€ëŠ¥í•œ ëŒ€ì²´ìž¬ë£Œ 2~4ê°œë¥¼ bullet í˜•íƒœë¡œ ì œì•ˆí•˜ê³ ,
     1) ëŒ€ì²´ìž¬ë£Œë¡œ ë°”ê¾¸ê¸°
     2) í•´ë‹¹ ìž¬ë£Œ ì—†ì´ ë§Œë“¤ê¸°
     ê°™ì€ ì„ íƒì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

2) ìž¬ë£Œ ë¹¼ê³  ì‹¶ìŒ:
   - "ë‹¹ê·¼ì€ ì•ˆ ë„£ê³  ì‹¶ì–´", "ë²„ì„¯ ë¹¼ì¤˜"
   â†’ í•´ë‹¹ ìž¬ë£Œë¥¼ fullIngredients/ingredients/stepsì—ì„œ ì œê±°í•˜ê³ ,
     ë³€ê²½ëœ ë ˆì‹œí”¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

3) ìž¬ë£Œ ë¶€ì¡±/ê³¼ë‹¤:
   - "~ë°–ì— ì—†ì–´", "~ì´ ë” ë§Žì•„", "2ê°œë°–ì— ì—†ìŒ", "4ê°œ ìžˆëŠ”ë°?" ë“±
   â†’ ë°˜ë“œì‹œ ì•„ëž˜ 3ê°€ì§€ ì„ íƒì§€ë¥¼ assistantMessageì— í¬í•¨í•©ë‹ˆë‹¤.

   1) ì§€ê¸ˆ ê°€ì§„ ì–‘ì— ë§žì¶° ë ˆì‹œí”¼ ì „ì²´ ë¹„ìœ¨ ì¡°ì •í•˜ê¸°
   2) ì›ëž˜ ë ˆì‹œí”¼ ê¸°ì¤€ ì–‘ë§Œ ì‚¬ìš©í•˜ê¸°
   3) í•´ë‹¹ ìž¬ë£Œë§Œ ì–‘ì„ ì¤„ì´ê±°ë‚˜ ëŠ˜ë ¤ì„œ ì¡°ì •í•˜ê¸°

   ì‚¬ìš©ìžê°€ ì„ íƒí•˜ë©´:
   - fullIngredientsì˜ ì–‘ì„ ìƒˆ ë¹„ìœ¨ì— ë§žê²Œ ì¡°ì •
   - steps ë‚´ìš©ë„ ì–‘ì— ë§žê²Œ ìžì—°ìŠ¤ëŸ½ê²Œ ìˆ˜ì •

4) ëª¨ë“  assistantMessageëŠ” ì˜ˆìœ í˜•ì‹ìœ¼ë¡œ ì¤„ë°”ê¿ˆ í¬í•¨

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[fullIngredients ìž¬ë£Œ ì¶œë ¥ ê·œì¹™ - follow-upì—ì„œë„ ìœ ì§€]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ë ˆì‹œí”¼ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ìž¬ìƒì„±í•  ë•Œ,
  fullIngredientsëŠ” í•­ìƒ "â€¢ ìž¬ë£Œ + ì–‘" í˜•ì‹ì˜ ë¬¸ìžì—´ ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆ:
"fullIngredients": [
  "â€¢ ë¬µì€ ê¹€ì¹˜ 300g",
  "â€¢ ë‘ë¶€ 200g",
  "â€¢ ë¼ì§€ê³ ê¸° ì•žë‹¤ë¦¬ì‚´ 150g"
]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ì¶œë ¥ JSON í˜•ì‹]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ:

{
  "assistantMessage": "",
  "recipe": {
    "recipeName": "",
    "fullIngredients": [],
    "ingredients": [],
    "steps": []
  }
}

JSON ì™¸ í…ìŠ¤íŠ¸ ì ˆëŒ€ ê¸ˆì§€.
`
      },
      {
        role: "user",
        content: `
í˜„ìž¬ ë ˆì‹œí”¼(JSON): ${JSON.stringify(recipeForGPT)}
ì‚¬ìš©ìž ìž…ë ¥: ${question}

ìœ„ ê·œì¹™ì„ ì§€ì¼œì„œ ì˜ˆì˜ê²Œ ë“¤ì—¬ì“°ê¸°ëœ assistantMessageì™€ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.
        `
      }
    ]
  });

  return JSON.parse(res.choices[0].message.content);
};



// ===============================
// intent
// ===============================
exports.askIntent = async (text) => {
  const res = await client.chat.completions.create({
    model: "gpt-4o-mini",
    response_format: { type: "json_object" },
    messages: [
      {
        role: "system",
        content: `
ë„ˆëŠ” ì‚¬ìš©ìžì˜ ìš”ë¦¬ ì‹œìž‘ ì˜ë„ë¥¼ íŒë‹¨í•˜ëŠ” AIì´ë‹¤.

start â†’ "ìš”ë¦¬ë¥¼ ì‹œìž‘í•˜ê² ë‹¤"ë¼ëŠ” ëª…í™•í•œ ì˜ë„ë¥¼ ê°€ì§„ ë§
none â†’ ê·¸ ì™¸ ëª¨ë“  ë§

ì˜ˆ:
"ì‹œìž‘í•´" â†’ start
"ì‘ ì‹œìž‘" â†’ start
"ã„±ã„±" â†’ start
"ê°€ë³´ìž" â†’ start

"ëŒ€íŒŒ ì—†ì–´" â†’ none  
"ëŒ€ì²´ìž¬ë£Œ ì•Œë ¤ì¤˜" â†’ none  
"ì˜¤ì´ 4ê°œ ìžˆì–´" â†’ none  

{"intent":"start"} ë˜ëŠ” {"intent":"none"} ë§Œ ì¶œë ¥
        `
      },
      { role: "user", content: text }
    ]
  });

  return JSON.parse(res.choices[0].message.content);
};



// ===============================
// STT
// ===============================
exports.stt = async (audioBuffer) => {
  try {
    const file = await toFile(audioBuffer, "audio.webm", {
      contentType: "audio/webm",
    });

    const res = await client.audio.transcriptions.create({
      file,
      model: "whisper-1",
    });

    return res.text;
  } catch (err) {
    console.error("STT Error:", err);
    throw new Error("STT ë³€í™˜ ì‹¤íŒ¨");
  }
};